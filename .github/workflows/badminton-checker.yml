name: ðŸ¸ Badminton Slot Checker

on:
  schedule:
    # Run every hour at 5 minutes past the hour
    - cron: '5 * * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      force_fresh_login:
        description: 'Force fresh login (check this if session expired)'
        type: boolean
        default: false

jobs:
  check-badminton-slots:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Increased for interactive OTP login with longer timeouts
    
    steps:
      - name: ðŸ¸ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2t64 libxss1 libatk-bridge2.0-0 libdrm2 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libxkbcommon0 libatspi2.0-0
      
      - name: ðŸ“¦ Install Python Dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium
      
      - name: ï¿½ Check for Session Artifact
        id: check-artifact
        run: |
          # Check if session-data artifact exists from previous runs
          ARTIFACT_EXISTS=$(gh api repos/${{ github.repository }}/actions/artifacts --jq '.artifacts[] | select(.name=="session-data") | .name' || echo "")
          if [ -n "$ARTIFACT_EXISTS" ]; then
            echo "artifact_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Session artifact found - will download"
          else
            echo "artifact_exists=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No session artifact found - fresh login required"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: ï¿½ðŸ’¾ Download Session Data
        if: steps.check-artifact.outputs.artifact_exists == 'true'
        uses: actions/download-artifact@v4
        with:
          name: session-data
          path: ./data
        id: download-session
      
      - name: ðŸ“‹ Session Status Check
        run: |
          echo "ðŸ” Session Status Summary:"
          if [ "${{ steps.check-artifact.outputs.artifact_exists }}" = "true" ]; then
            if [ "${{ steps.download-session.outcome }}" = "success" ]; then
              echo "âœ… Session data downloaded successfully"
              ls -la ./data/ || echo "No data directory found"
            else
              echo "âš ï¸ Session artifact found but download failed"
              mkdir -p ./data
            fi
          else
            echo "â„¹ï¸ No existing session found - this is normal for:"
            echo "   â€¢ First time running the workflow"
            echo "   â€¢ Session artifacts older than 7 days (expired)"  
            echo "   â€¢ Previous runs that didn't complete successfully"
            echo ""
            echo "ðŸ“ Creating data directory..."
            mkdir -p ./data
            echo "ðŸ” Fresh login will be required"
          fi
      
      - name: ðŸ” Check GitHub Secrets Setup
        env:
          PHONE_NUMBER: ${{ secrets.PHONE_NUMBER }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ðŸ” Checking GitHub Secrets configuration..."
          
          if [ -z "$PHONE_NUMBER" ]; then
            echo "âŒ PHONE_NUMBER secret is not configured"
            MISSING_SECRETS=true
          else
            echo "âœ… PHONE_NUMBER is configured"
          fi
          
          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "âŒ TELEGRAM_BOT_TOKEN secret is not configured"  
            MISSING_SECRETS=true
          else
            echo "âœ… TELEGRAM_BOT_TOKEN is configured"
          fi
          
          if [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âŒ TELEGRAM_CHAT_ID secret is not configured"
            MISSING_SECRETS=true
          else
            echo "âœ… TELEGRAM_CHAT_ID is configured"
          fi
          
          if [ "$MISSING_SECRETS" = "true" ]; then
            echo ""
            echo "ðŸš¨ SETUP REQUIRED ðŸš¨"
            echo "Please configure the missing secrets in your GitHub repository:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Add the missing secrets listed above"
            echo ""
            echo "For detailed instructions, see: GITHUB_ACTIONS_SETUP.md"
            echo ""
            exit 1
          fi
          
          echo "ðŸŽ‰ All secrets are configured! Proceeding with badminton check..."
      
      - name: ðŸ” Run Badminton Checker
        env:
          PHONE_NUMBER: ${{ secrets.PHONE_NUMBER }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FORCE_FRESH_LOGIN: ${{ github.event.inputs.force_fresh_login }}
        run: |
          python github_actions_checker.py
      
      - name: ðŸ’¾ Save Session Data
        if: always()
        run: |
          echo "ðŸ“‹ Checking for session data to save..."
          if [ -d "./data" ] && [ "$(ls -A ./data)" ]; then
            echo "âœ… Session data found, uploading artifact..."
            echo "UPLOAD_SESSION=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ No session data to save"
            echo "UPLOAD_SESSION=false" >> $GITHUB_ENV
          fi
      
      - name: ðŸ“¤ Upload Session Artifact
        if: always() && env.UPLOAD_SESSION == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: session-data
          path: ./data
          retention-days: 7
